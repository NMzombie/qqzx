<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <title>素材圈</title>
  <script src="../js/flexible.js"></script>
  <link rel="stylesheet" href="material-circle.css">
  <script src="../js/jquery-1.10.2.js"></script>
  <script src="../js/moment.min.js"></script>
  <script src="../js/cn.js"></script>
</head>
<body>

<div class="top_menu">
  <div class="common li-active">最新发布<div class="bottom-line"></div></div>
  <div class="common">最多下载<div class="bottom-line"></div></div>
  <div class="common">官方素材<div class="bottom-line"></div></div>
</div>
<div class="ul">
  <div class="bottom_content" style="left: 0;">
    <div class="body_1"></div>
    <div class="body_1"></div>
    <div class="body_1"></div>
  </div>
</div>
<script type="text/javascript">
  let allList = []
  const baseUrl = 'http://qqzx.xc2018.com.cn'
  addData(0, 1)
  function seeMore(index) {
    $('.content').eq(index).find('.open').hide()
    $('.content').eq(index).find('.detail').removeClass('txt-cut')
  }
  // 点赞功能
  function zanOperate(index, num, id) {
    const att = $('.content').eq(index).find('.operate-item').eq(0).find('.icon')
    const ht = $('.content').eq(index).find('.operate-item').eq(0).find('.value')
    if (att.attr('src').indexOf('zan.png') > -1) {
      ht.html() === '点赞' ? ht.html(1) : ht.html(num + 1)
      att.attr('src', 'http://file.wchoosemall.com/platform/manager/pic/zan-selected.png')
      const data = {
        id
      }
      $.ajax({
        type: 'post',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        url: `${baseUrl}/doc/api/common/auth/materialCircle/addFavoriteNum.json`,
        data: `data=${JSON.stringify(data)}`,
        success: (res) => {
        }
      })
    } else {
      ht.html() === '1' ? ht.html('点赞') : ht.html(num)
      att.attr('src', 'http://file.wchoosemall.com/platform/manager/pic/zan.png')
    }
  }
  // 下载功能
  function downloadOperate(index, num) {
    let group = ''
    for (let i = 0; i < allList[index].picUrls.length; i++) {
      group += allList[index].picUrls[i]
    }
    const ht = $('.content').eq(index).find('.operate-item').eq(1).find('.value')
    if (ht.html() === JSON.stringify(num) || ht.html() === '下载') {
      getMaterialPic(group)
      ht.html(num + 1)
    }
  }
  let newInd = 1
  let moreInd = 1
  let basicInd = 1
  // tab切换功能（滑动）
  $('.bottom_content')[0].style.left = "0%"
  var startX = '',disX =''
  $('.top_menu').on('click','.common',function(){
    var index = $(this).index()
    if (index === 1) {
      $('.body_1').eq(0).html('')
      $('.body_1').eq(2).html('')
      addData(1, newInd)
    } else if (index === 2) {
      $('.body_1').eq(0).html('')
      $('.body_1').eq(1).html('')
      addData(2, moreInd)
    } else {
      $('.body_1').eq(1).html('')
      $('.body_1').eq(2).html('')
      addData(0, basicInd)
    }
    $('.bottom_content').css('left','-' + index * 100 + '%')
    $('.top_menu .common').eq(index).addClass('li-active').siblings().removeClass('li-active')
  })
  $('.bottom_content').on('touchstart','.body_1',function(e){
    startX = e.originalEvent.changedTouches[0].clientX
  })
  $('.bottom_content').on('touchmove','.body_1',function(e){
    e.stopPropagation()
  })
  $('.bottom_content').on('touchend','.body_1',function(e){
    disX = e.originalEvent.changedTouches[0].clientX - startX
    var leftNum = parseInt($('.bottom_content')[0].style.left)
    let order
    if(disX > 0 && disX > 100) {
      if(leftNum <= -100) {
        $('.bottom_content')[0].style.left = leftNum + 100 + "%"
        order = -parseInt($('.bottom_content')[0].style.left)/100
        $('.top_menu .common').eq(order).addClass('li-active').siblings().removeClass('li-active')
      }
    } else if(disX < 0 && disX < -100) {
      if(leftNum >= -100) {
        $('.bottom_content')[0].style.left = leftNum - 100 + "%"
        order = (-parseInt($('.bottom_content')[0].style.left))/100
        $('.top_menu .common').eq(order).addClass('li-active').siblings().removeClass('li-active')
      }
    }
    if (disX > 0 && disX > 100 || disX < 0 && disX < -100) {
      if (order === 1) {
        $('.body_1').eq(0).html('')
        $('.body_1').eq(2).html('')
        addData(1, moreInd)
      } else if (order === 2) {
        $('.body_1').eq(0).html('')
        $('.body_1').eq(1).html('')
        addData(2, basicInd)
      } else {
        $('.body_1').eq(1).html('')
        $('.body_1').eq(2).html('')
        addData(0, newInd)
      }
    }
  })

  // 数据拼接
  function addData (index, page) {
    const data = {
      type: index,
      page
    }
    $.ajax({
      type: 'post',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      url: `${baseUrl}/doc/api/common/auth/materialCircle/findMaterialCircle.json`,
      data: `data=${JSON.stringify(data)}`,
      success: (res) => {
        allList = res.data.list
        const data = res.data.list
        for (let i = 0; i < data.length; i++) {
          let fir = `<div class="content"><div class="header-item clearfix"><img class="header-img" src="${data[i].avatar}" alt="" /><div class="name-item"><div class="name">${data[i].nickName}</div><div class="time">${moment(data[i].createTime).from(data[i].currentTime)}发布</div></div></div><div class="art"><div class="content-item"><div class="content-title clearfix"><div class="content-tag">${data[i].customLabel}</div><div class="title one-txt-cut">${data[i].title}</div></div><div class="detail txt-cut">${data[i].recommendedReason}</div>`
          if (data[i].recommendedReason.length >= 105) {
            fir += `<div class="open"><a href="javascript:void(0)" onclick="seeMore(${i})">全文</a></div>`
          }
          fir += `</div></div><div class="img-list"><div class="image clearfix">`
          let sec = ``
          for (let j = 0; j < data[i].picUrls.length; j++) {
            sec += `<img class="img-item" src="${data[i].picUrls[j]}" />`
          }
          const thi = `</div></div><div class="operate clearfix"><a href="javascript:void(0)" onclick="zanOperate(${i}, ${data[i].favoriteNum}, ${data[i].id})"><div class="operate-item clearfix"><img class="icon" src="http://file.wchoosemall.com/platform/manager/pic/zan.png" />`
          let zan = ``
          data[i].favoriteNum === 0 ? zan += `<div class="value">点赞</div>` : zan += `<div class="value">${data[i].favoriteNum}</div>`
          let down = `</div></a><a href="javascript:void(0)" onclick="downloadOperate(${i}, ${data[i].downloadNum})"><div class="operate-item clearfix"><img class="icon" src="http://file.wchoosemall.com/platform/manager/pic/download.png" />`
          data[i].downloadNum === 0 ? down += `<div class="value">下载</div>` : down = `<div class="value">data[i].downloadNum</div>`
          const last = `</div></a></div></div>`
          $('.body_1').eq(index).append(fir + sec + thi + zan + down + last)
        }
      }
    })
  }

  // app js bridge
  function getMaterialPic (id) {
    if (window.WebViewJavascriptBridge) {
      window.WebViewJavascriptBridge.callHandler('getMaterialPic', {id}, function (response) {
        console.log(1, response)
      })
    } else {
      setTimeout(() => {
        getMaterialPic()
      }, 50)
    }
  }

</script>
</body>
</html>
