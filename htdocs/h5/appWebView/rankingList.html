<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,telephone=no">
  <title>今日爆款</title>
  <link rel="stylesheet" href="ranking-list.css">
  <script src="../js/jquery-1.10.2.js"></script>
  <script src="../js/util.js"></script>
</head>
<body>
<div class="header">
  <img src="http://file.wchoosemall.com/platform/manager/pic/ranking-title.png" alt="" />
</div>
<div class="today-list">
  <img class="header-img" src="http://file.wegoomall.cn/platform/manager/pic/20181213/5058458903637603.png" alt="" />
  <div class="list clearfix">
    <div class="list-title clearfix">
      <div class="item left">爆款商品</div>
      <div class="item middle-left">今日销售</div>
      <!--<div class="item middle-right">今日收益</div>-->
      <div class="item right">详情</div>
    </div>
    <div class="list-all"></div>
  </div>
</div>
<div class="share-all">
  <div class="share-title">爆款商品详情</div>
  <div class="share-list"></div>
</div>
<script type="text/javascript">
  function connectWebViewJavascriptBridge (callback) {
    if (window.WebViewJavascriptBridge) {
      callback(window.WebViewJavascriptBridge)
    } else {
      document.addEventListener('WebViewJavascriptBridgeReady', function () {
        callback(window.WebViewJavascriptBridge)
      }, false)
      if (window.WVJBCallbacks) {
        return window.WVJBCallbacks.push(callback)
      }
      window.WVJBCallbacks = [callback]
      var WVJBIframe = document.createElement('iframe')
      WVJBIframe.style.display = 'none'
      WVJBIframe.src = 'https://__bridge_loaded__'
      document.documentElement.appendChild(WVJBIframe)
      setTimeout(function () {
        document.documentElement.removeChild(WVJBIframe)
      }, 0)
    }
  }
  // 注册回调函数，第一次连接时调用 初始化函数
  // bridge.init 只有android需要调用初始化，可以使用Object.keys(bridge) 打开查看对象，ios没有init方法
  connectWebViewJavascriptBridge(function (bridge) {
    try {
      bridge.init(function (message, responseCallback) {
        console.log('JS got a message', message)
        var data = {
          'Javascript Responds': 'CMYH!'
        }
        console.log('JS responding with', data)
        responseCallback(data)
      })
    } catch (e) {
      console.log(e)
    }
  })
  let baseUrl = ''
  getQueryString('dev') ? baseUrl = 'http://qqzx.xc2018.com.cn' : baseUrl = 'http://api.wchoosemall.com'
  let rankingList = ''
  getUserInfo()
  function getUserInfo (){
    if (window.WebViewJavascriptBridge) {
      window.WebViewJavascriptBridge.callHandler('getUserInfo', {}, function (response) {
        const token = JSON.parse(response).token
        const level = JSON.parse(response).level
        $('.header-img').attr('src', JSON.parse(response).avatar)
        $.ajax({
          type: 'post',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          url: `${baseUrl}/doc/api/common/auth/memberSales/getItemSales.json?token=${token}`,
          success: (res) => {
            rankingList = res.data.list
            for (let i = 0; i < rankingList.length; i++) {
              $('.list-all').append(`<div class="list-goods clearfix"><div class="item left"><a href="javascript:void(0)" onclick="loadMore(${rankingList[i].itemRankDTO.itemId})" ><img src="${rankingList[i].itemRankDTO.picUrls[0]}_400w.jpg" alt="" /></a></div><div class="item middle-left">￥${priceFormat(rankingList[i].memberSalesDTO.salesPrice)}</div><div class="item right"><a href="javascript:void(0)" onclick="loadRanking(${rankingList[i].itemRankDTO.activityId})" >查看排行</a></div></div>`)
              if (level >= 10) {
                $('.share-list').append(`<div class="item bor-b clearfix"><a href="javascript:void(0)" onclick="loadMore(${rankingList[i].itemRankDTO.itemId})" ><img class="left" src="${rankingList[i].itemRankDTO.picUrls[0]}_400w.jpg" /></a><div class="right"><div class="title one-txt-cut">${rankingList[i].itemRankDTO.name}</div><div class="content clearfix"><div class="member">￥${priceFormat(rankingList[i].itemRankDTO.memberPrice)}</div><div class="market">￥${priceFormat(rankingList[i].itemRankDTO.marketPrice)}</div><a href="javascript:void(0)" onclick="shareItem(${i})"><div class="share">分享</div></a></div></div></div>`)
              } else {
                $('.share-list').append(`<div class="item bor-b clearfix"><a href="javascript:void(0)" onclick="loadMore(${rankingList[i].itemRankDTO.itemId})" ><img class="left" src="${rankingList[i].itemRankDTO.picUrls[0]}_400w.jpg" /></a><div class="right"><div class="title one-txt-cut">${rankingList[i].itemRankDTO.name}</div><div class="content clearfix"><div class="member">￥${priceFormat(rankingList[i].itemRankDTO.marketPrice)}</div><div class="market">￥${priceFormat(rankingList[i].itemRankDTO.showPrice)}</div><a href="javascript:void(0)" onclick="shareItem(${i})"><div class="share">分享</div></a></div></div></div>`)
              }
             }
          }
        })
      })
    } else {
      setTimeout(() => {
        getUserInfo()
      }, 50)
    }
  }






  // 测试数据
  // const token = 'ac6e0b60d7994301b12aa4e6311629'
  // const level = 10
  // // $('.header-img').attr('src', JSON.parse(response).avatar)
  // $.ajax({
  //   type: 'post',
  //   headers: {
  //     'Content-Type': 'application/x-www-form-urlencoded'
  //   },
  //   url: `${baseUrl}/doc/api/common/auth/memberSales/getItemSales.json?token=${token}`,
  //   success: (res) => {
  //     rankingList = res.data.list
  //     for (let i = 0; i < rankingList.length; i++) {
  //       $('.list-all').append(`<div class="list-goods clearfix"><div class="item left"><a href="javascript:void(0)" onclick="loadMore(${rankingList[i].itemRankDTO.itemId})" ><img src="${rankingList[i].itemRankDTO.picUrls[0]}_400w.jpg" alt="" /></a></div><div class="item middle-left">￥${priceFormat(rankingList[i].memberSalesDTO.salesPrice)}</div><div class="item right"><a href="javascript:void(0)" onclick="loadRanking(${rankingList[i].itemRankDTO.activityId})" >查看排行</a></div></div>`)
  //       if (level >= 10) {
  //         $('.share-list').append(`<div class="item bor-b clearfix"><a href="javascript:void(0)" onclick="loadMore(${rankingList[i].itemRankDTO.itemId})" ><img class="left" src="${rankingList[i].itemRankDTO.picUrls[0]}_400w.jpg" /></a><div class="right"><div class="title one-txt-cut">${rankingList[i].itemRankDTO.name}</div><div class="content clearfix"><div class="member">￥${priceFormat(rankingList[i].itemRankDTO.memberPrice)}</div><div class="market">￥${priceFormat(rankingList[i].itemRankDTO.marketPrice)}</div><a href="javascript:void(0)" onclick="shareItem(${i})"><div class="share">分享</div></a></div></div></div>`)
  //       } else {
  //         $('.share-list').append(`<div class="item bor-b clearfix"><a href="javascript:void(0)" onclick="loadMore(${rankingList[i].itemRankDTO.itemId})" ><img class="left" src="${rankingList[i].itemRankDTO.picUrls[0]}_400w.jpg" /></a><div class="right"><div class="title one-txt-cut">${rankingList[i].itemRankDTO.name}</div><div class="content clearfix"><div class="member">￥${priceFormat(rankingList[i].itemRankDTO.marketPrice)}</div><div class="market">￥${priceFormat(rankingList[i].itemRankDTO.showPrice)}</div><a href="javascript:void(0)" onclick="shareItem(${i})"><div class="share">分享</div></a></div></div></div>`)
  //       }
  //     }
  //   }
  // })








  function loadMore(id) {
    if (window.WebViewJavascriptBridge) {
      window.WebViewJavascriptBridge.callHandler('getUrlTo', {'page': `wg://push.chuang.co?page=prodDetail&prodId=${id}`}, function (response) {
      })
    } else {
      setTimeout(() => {
        loadMore(id)
      }, 50)
    }
  }
  function loadRanking(id) {
    getQueryString('dev') ? window.location.href = `./rankingDetail.html?activityId=${id}&fullscreen=1&dev=1` : window.location.href = `./rankingDetail.html?activityId=${id}&fullscreen=1`
  }
  function shareItem(ind) {
    if (window.WebViewJavascriptBridge) {
      window.WebViewJavascriptBridge.callHandler('getShareInfo', {'itemId': `${rankingList[ind].itemRankDTO.itemId}`, 'title': `${rankingList[ind].itemRankDTO.name}`, 'desc': `${rankingList[ind].itemRankDTO.name}`, 'img': `${rankingList[ind].itemRankDTO.picUrls[0]}`, 'price': `${rankingList[ind].itemRankDTO.marketPrice}`}, function (response) {
      })
    } else {
      setTimeout(() => {
        shareItem(ind)
      }, 50)
    }
  }
</script>
</body>
</html>
