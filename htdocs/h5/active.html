<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,telephone=no">
  <title>暖心情人节</title>
  <link rel="stylesheet" href="css/active.css">
  <link rel="stylesheet" href="css/sweetalert.css">
  <script>
    fnResize()
    window.onresize = function () {
      fnResize()
    }
    function fnResize () {
      var deviceWidth = document.documentElement.clientWidth || window.innerWidth
      if (deviceWidth >= 750) {
        deviceWidth = 750
      }
      if (deviceWidth <= 320) {
        deviceWidth = 320
      }
      document.documentElement.style.fontSize = (deviceWidth / 7.5) + 'px'
    }
  </script>
</head>
<body>
<div class="header">
  <img class="activity-pic" src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1550227401126&di=c71da042c8413046922f2e5751cd2226&imgtype=0&src=http%3A%2F%2Fimg.qqzhi.com%2Fuploads%2F2018-12-29%2F145607665.jpg" alt="" />
</div>
<div class="active-main">
  <div class="coupon clearfix"></div>
  <div class="desc">注：限<span class="start-date"></span>-<span class="end-date"></span>可用</div>
  <nav class="nav">
    <div class="tab-area clearfix"></div>
  </nav>
  <div class="act-con"></div>
</div>
<script src="./js/jquery-1.10.2.js"></script>
<script src="./js/jquery.navScroll.js"></script>
<script src="./js/util.js"></script>
<script type="text/javascript">
  // webview连接
  function connectWebViewJavascriptBridge (callback) {
    if (window.WebViewJavascriptBridge) {
      callback(window.WebViewJavascriptBridge)
    } else {
      document.addEventListener('WebViewJavascriptBridgeReady', function () {
        callback(window.WebViewJavascriptBridge)
      }, false)
      if (window.WVJBCallbacks) {
        return window.WVJBCallbacks.push(callback)
      }
      window.WVJBCallbacks = [callback]
      var WVJBIframe = document.createElement('iframe')
      WVJBIframe.style.display = 'none'
      WVJBIframe.src = 'https://__bridge_loaded__'
      document.documentElement.appendChild(WVJBIframe)
      setTimeout(function () {
        document.documentElement.removeChild(WVJBIframe)
      }, 0)
    }
  }
  // 注册回调函数，第一次连接时调用 初始化函数
  // bridge.init 只有android需要调用初始化，可以使用Object.keys(bridge) 打开查看对象，ios没有init方法
  connectWebViewJavascriptBridge(function (bridge) {
    try {
      bridge.init(function (message, responseCallback) {
        console.log('JS got a message', message)
        var data = {
          'Javascript Responds': 'CMYH!'
        }
        console.log('JS responding with', data)
        responseCallback(data)
      })
    } catch (e) {
      console.log(e)
    }
  })
  // 获取优惠券信息
  function getTicket (id){
    if (window.WebViewJavascriptBridge) {
      window.WebViewJavascriptBridge.callHandler('getTicket', {'id': `${id}`}, function (response) {
      })
    } else {
      setTimeout(() => {
        getTicket(id)
      }, 50)
    }
  }
  // 获取客户端url跳转
  function buyNow (id){
    if (window.WebViewJavascriptBridge) {
      window.WebViewJavascriptBridge.callHandler('getUrlTo', {'page': `wg://push.chuang.co?page=prodDetail&prodId=${id}`}, function (response) {
      })
    } else {
      setTimeout(() => {
        buyNow(id)
      }, 50)
    }
  }
  // 获取客户端用户信息
  function getUserInfo (){
    if (window.WebViewJavascriptBridge) {
      window.WebViewJavascriptBridge.callHandler('getUserInfo', {}, function (response) {
        const level = JSON.parse(response).level
        // 活动数据拉取
        const activityId = {
          activityId: getQueryString('activityId')
        }
        // const baseUrl = window.location.host
        const baseUrl = 'http://qqzx.xc2018.com.cn'
        $.ajax({
          type : 'post',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          url: `${baseUrl}/doc/api/common/activity/findActivity.json`,
          data: `data=${JSON.stringify(activityId)}`,
          success: (res) => {
            const data = res.data.activityVO
            const startDate = `${new Date(data.activity.startDate).getMonth() + 1}.${new Date(data.activity.startDate).getDate()}`
            const endDate = `${new Date(data.activity.endDate).getMonth() + 1}.${new Date(data.activity.endDate).getDate()}`
            $('.start-date').html(startDate)
            $('.end-date').html(endDate)
            $('.activity-pic').attr('src', data.activity.picUrl)
            $('title').html(data.activity.name)
            const couponList = data.couponDOList
            // 优惠券遍历
            for (let i = 0; i < couponList.length; i++) {
              if (couponList.length === 1) {
                $('.coupon').append(`<a href="javascript:void(0);" onclick="getTicket(${couponList[i].id})"><img class="large-card" src="${couponList[i].picUrl}" /></a>`)
              } else {
                // 偶数优惠券
                if (couponList.length % 2 === 0) {
                  if (i % 2 === 0) {
                    $('.coupon').append(`<a href="javascript:void(0);" onclick="getTicket(${couponList[i].id})"><img class="small-card" src="${couponList[i].picUrl}" /></a>`)
                  } else {
                    $('.coupon').append(`<a href="javascript:void(0);" onclick="getTicket(${couponList[i].id})"><img class="small-card m-l12" src="${couponList[i].picUrl}" /></a>`)
                  }
                } else {
                  // 奇数优惠券
                  if (couponList.length !== i + 1) {
                    // 非最后一行
                    if (i % 2 === 0) {
                      $('.coupon').append(`<a href="javascript:void(0);" onclick="getTicket(${couponList[i].id})"><img class="small-card" src="${couponList[i].picUrl}" /></a>`)
                    } else {
                      $('.coupon').append(`<a href="javascript:void(0);" onclick="getTicket(${couponList[i].id})"><img class="small-card m-l12" src="${couponList[i].picUrl}" /></a>`)
                    }
                  } else {
                    //  最后一行
                    $('.coupon').append(`<a href="javascript:void(0);" onclick="getTicket(${couponList[i].id})"><img class="large-card" src="${couponList[i].picUrl}" /></a>`)
                  }
                }
              }
            }
            // 商品清单
            const list = data.itemGroups
            for (let i = 0; i < list.length; i++) {
              // 插入标题区块
              $('.tab-area').append(`<a href="#tab${list[i].id}">${list[i].groupName}</a>`)
              // 插入题目
              $('.act-con').append(`<div class="act-title">// ${list[i].groupName} //</div>`)
              // 插入内容区块
              const fir = `<div class="type-${list[i].styleType} clearfix" id="tab${list[i].id}">`
              let sec = ''
              const thi = `</div>`
              // 全部商品插入区
              for (let o = 0; o < list[i].items.length; o++) {
                if (list[i].styleType === 1) {
                  // 根据用户等级判断展示价格
                  if (level >= 10) {
                    sec = sec + `<div class="type-goods-${list[i].styleType} clearfix"><img class="type-img-${list[i].styleType}" src="${list[i].items[o].picUrls[0]}" /><div class="type-title-${list[i].styleType} txt-cut">${list[i].items[o].title}</div><div class="type-price-${list[i].styleType} clearfix"><div class="market">¥${priceFormat(list[i].items[o].marketPrice)}</div><div class="member">¥${priceFormat(list[i].items[o].memberPrice)}</div></div><div><input class="type-buy-${list[i].styleType}" type="button" value="立即购买" onclick="buyNow(${list[i].items[o].id})" /></div></div>`
                  } else {
                    sec = sec + `<div class="type-goods-${list[i].styleType} clearfix"><img class="type-img-${list[i].styleType}" src="${list[i].items[o].picUrls[0]}" /><div class="type-title-${list[i].styleType} txt-cut">${list[i].items[o].title}</div><div class="type-price-${list[i].styleType} clearfix"><div class="market">¥${priceFormat(list[i].items[o].showPrice)}</div><div class="member">¥${priceFormat(list[i].items[o].marketPrice)}</div></div><div><input class="type-buy-${list[i].styleType}" type="button" value="立即购买" onclick="buyNow(${list[i].items[o].id})" /></div></div>`
                  }
                } else {
                  // 根据用户等级判断展示价格
                  if (level >= 10) {
                    sec = sec + `<div class="type-goods-${list[i].styleType} clearfix"><img class="type-img-${list[i].styleType}" src="${list[i].items[o].picUrls[0]}" /><div class="type-title-${list[i].styleType} txt-cut">${list[i].items[o].title}</div><div class="type-price-${list[i].styleType} clearfix"><div class="member">¥${priceFormat(list[i].items[o].memberPrice)}</div><div class="market">¥${priceFormat(list[i].items[o].marketPrice)}</div></div><div><input class="type-buy-${list[i].styleType}" type="button" value="立即购买" onclick="buyNow(${list[i].items[o].id})" /></div></div>`
                  } else {
                    sec = sec + `<div class="type-goods-${list[i].styleType} clearfix"><img class="type-img-${list[i].styleType}" src="${list[i].items[o].picUrls[0]}" /><div class="type-title-${list[i].styleType} txt-cut">${list[i].items[o].title}</div><div class="type-price-${list[i].styleType} clearfix"><div class="member">¥${priceFormat(list[i].items[o].marketPrice)}</div><div class="market">¥${priceFormat(list[i].items[o].showPrice)}</div></div><div><input class="type-buy-${list[i].styleType}" type="button" value="立即购买" onclick="buyNow(${list[i].items[o].id})" /></div></div>`
                  }
                }
              }
              $('.act-con').append(fir + sec + thi)
            }
          }
        })
      })
    } else {
      setTimeout(() => {
        getUserInfo()
      }, 50)
    }
  }
  getUserInfo()

  // 滚动动销
  const getDiv_md = $(".tab-area");
  const offSet = getDiv_md.offset().top;
  $(window).scroll(function(){
    // 浮层效果
    if ($(window).scrollTop() > offSet){
      getDiv_md.css({"position":"fixed","top":"0","z-index":"2"});
    }else{
      getDiv_md.css({"position":"","left":"0px","top":"","z-index":""});
    }
  })
  // 滚动实例化
  $('.nav').navScroll({
    mobileDropdown: true,
    mobileBreakpoint: 768,
    scrollSpy: true
  });
</script>
</body>
</html>

